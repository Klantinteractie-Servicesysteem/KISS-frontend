name: Playwright Tests
on:
  schedule:
    - cron: "0 16 * * *"
  pull_request:
    branches: [main, master]
    paths: ["Kiss.Bff.EndToEndTest/**"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: playwright-tests-group
  cancel-in-progress: false

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      - name: Build
        working-directory: ./Kiss.Bff.EndToEndTest
        run: dotnet build
      
      - name: Ensure browsers are installed
        working-directory: ./Kiss.Bff.EndToEndTest
        run: pwsh bin/Debug/net8.0/playwright.ps1 install --with-deps
      
      - name: Run all tests (first run)
        id: first-run
        continue-on-error: true
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          dotnet test \
            --no-build \
            --logger "console;verbosity=normal" \
            2>&1 | tee test-output.log
        env:
          TestSettings__TEST_USERNAME: ${{ secrets.PLAYWRIGHT_USERNAME }}
          TestSettings__TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_PASSWORD }}
          TestSettings__TEST_TOTP_SECRET: ${{ secrets.PLAYWRIGHT_TOTP_SECRET }}
          TestSettings__TEST_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_BASE_URL: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_SECRET: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_SECRET }}

      - name: Extract and retry failed tests
        if: steps.first-run.outcome == 'failure'
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          echo "‚ö†Ô∏è First run had failures. Extracting failed test names from output..."
          
          # Extract failed test names from the output log
          # MSTest outputs: "Failed TestName [duration]"
          FAILED_TESTS=$(grep -oP '(?<=Failed\s).*?(?=\s\[)' test-output.log | sort -u || true)
          
          if [ -z "$FAILED_TESTS" ]; then
            echo "‚ùå Could not extract failed test names from output"
            echo "Showing last 50 lines of test output:"
            tail -50 test-output.log
            exit 1
          fi
          
          FAILED_COUNT=$(echo "$FAILED_TESTS" | wc -l | tr -d ' ')
          echo ""
          echo "üìä Found $FAILED_COUNT failed test(s):"
          echo "$FAILED_TESTS"
          echo ""
          
          RETRY_PASSED=0
          RETRY_FAILED=0
          
          # Retry each failed test
          while IFS= read -r test_name; do
            if [ -n "$test_name" ]; then
              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üîÑ Retrying: $test_name"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              
              if dotnet test \
                --no-build \
                --filter "DisplayName~${test_name}" \
                --logger "console;verbosity=normal"; then
                echo "   ‚úÖ PASSED on retry"
                ((RETRY_PASSED++))
              else
                echo "   ‚ùå FAILED again"
                ((RETRY_FAILED++))
              fi
            fi
          done <<< "$FAILED_TESTS"
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìä Retry Results"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "Tests failed initially: $FAILED_COUNT"
          echo "Passed on retry:        $RETRY_PASSED"
          echo "Still failed:           $RETRY_FAILED"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # If any tests still failed after retry, exit with failure
          if [ $RETRY_FAILED -gt 0 ]; then
            echo ""
            echo "‚ùå $RETRY_FAILED test(s) still failing after retry"
            exit 1
          else
            echo ""
            echo "‚úÖ All failed tests passed on retry!"
          fi
        env:
          TestSettings__TEST_USERNAME: ${{ secrets.PLAYWRIGHT_USERNAME }}
          TestSettings__TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_PASSWORD }}
          TestSettings__TEST_TOTP_SECRET: ${{ secrets.PLAYWRIGHT_TOTP_SECRET }}
          TestSettings__TEST_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_BASE_URL: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_SECRET: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_SECRET }}

      - name: Generate Summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.first-run.outcome }}" == "success" ]; then
            echo "‚úÖ **All tests passed on first run!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **First run had failures, failed tests were automatically retried**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for detailed retry results." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä [View detailed test report](https://klantinteractie-servicesysteem.github.io/KISS-frontend/)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./Kiss.Bff.EndToEndTest/bin/Debug/net8.0/playwright-traces"
      
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: Kiss.Bff.EndToEndTest/bin/Debug/net8.0/screenshots/
          retention-days: 30

  deploy:
    if: ${{ always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}
    needs: test
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
