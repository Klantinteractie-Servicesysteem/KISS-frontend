name: Playwright Tests
on:
  schedule:
    - cron: "0 16 * * *"
  pull_request:
    branches: [main, master]
    paths: ["Kiss.Bff.EndToEndTest/**"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: playwright-tests-group
  cancel-in-progress: false

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      - name: Build
        working-directory: ./Kiss.Bff.EndToEndTest
        run: dotnet build
      
      - name: Ensure browsers are installed
        working-directory: ./Kiss.Bff.EndToEndTest
        run: pwsh bin/Debug/net8.0/playwright.ps1 install --with-deps
      
      - name: Run your tests (first-run)
        id: first-run
        continue-on-error: true
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          dotnet test --logger "trx;LogFileName=first-run.trx" --results-directory ./TestResults --verbosity normal
        env:
          TestSettings__TEST_USERNAME: ${{ secrets.PLAYWRIGHT_USERNAME }}
          TestSettings__TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_PASSWORD }}
          TestSettings__TEST_TOTP_SECRET: ${{ secrets.PLAYWRIGHT_TOTP_SECRET }}
          TestSettings__TEST_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_BASE_URL: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_SECRET: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_SECRET }}

      - name: Debug - Check TRX file location
        if: always()
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          echo "=== Looking for TRX files ==="
          find ./TestResults -name "*.trx" -type f || echo "No TRX files found"

      - name: Parse Failed Tests and Retry
        if: steps.first-run.outcome == 'failure'
        id: retry
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          echo "‚ö†Ô∏è Some tests failed on first run. Analyzing failures..."
          
          # Install xmlstarlet for XML parsing
          sudo apt-get update -qq && sudo apt-get install -y -qq xmlstarlet
          
          # Find the TRX file (might be in subdirectory)
          TRX_FILE=$(find ./TestResults -name "first-run.trx" -o -name "*.trx" | head -1)
          
          if [ -z "$TRX_FILE" ]; then
            echo "‚ùå No TRX file found"
            find ./TestResults -type f
            exit 1
          fi
          
          echo "‚úÖ Found TRX file: $TRX_FILE"
          
          # Parse failed test names from TRX file
          FAILED_TESTS=$(xmlstarlet sel -t -m "//ns:UnitTestResult[@outcome='Failed']" -v "@testName" -n \
            -N ns="http://microsoft.com/schemas/VisualStudio/TeamTest/2010" \
            "$TRX_FILE" 2>/dev/null | sort -u)
          
          if [ -z "$FAILED_TESTS" ]; then
            echo "‚ùå Tests failed but no failed tests found in TRX report"
            echo "retry_failed=999" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          FAILED_COUNT=$(echo "$FAILED_TESTS" | wc -l | tr -d ' ')
          echo "üìä Found $FAILED_COUNT failed test(s). Retrying individually..."
          echo ""
          
          RETRY_PASSED=0
          RETRY_FAILED=0
          
          # Retry each failed test individually
          while IFS= read -r test_name; do
            if [ -n "$test_name" ]; then
              echo "üîÑ Retrying: $test_name"
              
              # Sanitize test name for filename
              SAFE_NAME=$(echo "$test_name" | sed 's/[^a-zA-Z0-9]/_/g')
              
              if dotnet test \
                --no-build \
                --filter "FullyQualifiedName~${test_name}" \
                --logger "trx;LogFileName=retry-${SAFE_NAME}.trx" \
                --results-directory ./TestResults \
                --verbosity quiet; then
                echo "   ‚úÖ PASSED on retry"
                ((RETRY_PASSED++))
              else
                echo "   ‚ùå Still FAILED"
                ((RETRY_FAILED++))
              fi
              echo ""
            fi
          done <<< "$FAILED_TESTS"
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìä Retry Summary"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "Total failed on first run: $FAILED_COUNT"
          echo "Passed on retry:          $RETRY_PASSED"
          echo "Still failed:             $RETRY_FAILED"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          echo "total_failed=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "retry_passed=$RETRY_PASSED" >> $GITHUB_OUTPUT
          echo "retry_failed=$RETRY_FAILED" >> $GITHUB_OUTPUT
          
          if [ $RETRY_FAILED -gt 0 ]; then
            exit 1
          fi
        env:
          TestSettings__TEST_USERNAME: ${{ secrets.PLAYWRIGHT_USERNAME }}
          TestSettings__TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_PASSWORD }}
          TestSettings__TEST_TOTP_SECRET: ${{ secrets.PLAYWRIGHT_TOTP_SECRET }}
          TestSettings__TEST_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_BASE_URL: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_SECRET: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_SECRET }}

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## üß™ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.first-run.outcome }}" == "success" ]; then
            echo "‚úÖ **All tests passed on first run!**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.retry.outcome }}" == "success" ]; then
            echo "‚úÖ **All tests passed after retry!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Failed on first run | ${{ steps.retry.outputs.total_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed on retry | ${{ steps.retry.outputs.retry_passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Still failed | 0 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some tests still failing after retry**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.retry.outputs.retry_failed }}" ]; then
              echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Failed on first run | ${{ steps.retry.outputs.total_failed }} |" >> $GITHUB_STEP_SUMMARY
              echo "| Passed on retry | ${{ steps.retry.outputs.retry_passed }} |" >> $GITHUB_STEP_SUMMARY
              echo "| Still failed | ${{ steps.retry.outputs.retry_failed }} |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä [View detailed test report](https://klantinteractie-servicesysteem.github.io/KISS-frontend/)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-trx
          path: Kiss.Bff.EndToEndTest/TestResults/
          retention-days: 30

      - name: Upload artifact
        if: ${{ always() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./Kiss.Bff.EndToEndTest/bin/Debug/net8.0/playwright-traces"
      
      - name: Upload Playwright screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: Kiss.Bff.EndToEndTest/bin/Debug/net8.0/screenshots/

  deploy:
    if: ${{ always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}
    needs: test
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
