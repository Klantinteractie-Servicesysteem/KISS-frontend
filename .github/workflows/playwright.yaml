name: Playwright Tests
on:
  schedule:
    - cron: "0 16 * * *"
  pull_request:
    branches: [main, master]
    paths: ["Kiss.Bff.EndToEndTest/**"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: playwright-tests-group
  cancel-in-progress: false

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      
      - name: Build
        working-directory: ./Kiss.Bff.EndToEndTest
        run: dotnet build
      
      - name: Ensure browsers are installed
        working-directory: ./Kiss.Bff.EndToEndTest
        run: pwsh bin/Debug/net8.0/playwright.ps1 install --with-deps
      
      - name: Run all tests (first attempt)
        id: first-run
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          set +e
          dotnet test --no-build --logger "console;verbosity=detailed" 2>&1 | tee test-output.log
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "First run exit code: $EXIT_CODE"
          exit 0
        env:
          TestSettings__TEST_USERNAME: ${{ secrets.PLAYWRIGHT_USERNAME }}
          TestSettings__TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_PASSWORD }}
          TestSettings__TEST_TOTP_SECRET: ${{ secrets.PLAYWRIGHT_TOTP_SECRET }}
          TestSettings__TEST_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_BASE_URL: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_SECRET: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_SECRET }}

      - name: Extract and retry only failed tests
        if: steps.first-run.outputs.exit_code != '0'
        id: retry-run
        working-directory: ./Kiss.Bff.EndToEndTest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  FIRST RUN FAILED - Extracting failed tests..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Extract failed test names from MSTest output
          # MSTest format: "  Failed TestMethodName [duration]"
          FAILED_TESTS=$(grep "^\s*Failed " test-output.log | sed 's/^\s*Failed //' | sed 's/ \[.*//' | sort -u)
          
          if [ -z "$FAILED_TESTS" ]; then
            echo "âŒ Could not extract failed test names"
            echo ""
            echo "=== Searching for test failures in output ==="
            grep -E "(Failed|Error|Exception)" test-output.log | head -30
            echo ""
            echo "âš ï¸  Falling back to re-running ALL tests..."
            dotnet test --no-build --logger "console;verbosity=normal"
            exit $?
          fi
          
          FAILED_COUNT=$(echo "$FAILED_TESTS" | wc -l | tr -d ' ')
          echo "ğŸ“Š Found $FAILED_COUNT failed test(s):"
          echo "$FAILED_TESTS"
          echo ""
          
          RETRY_PASSED=0
          RETRY_FAILED=0
          
          # Retry each failed test individually
          while IFS= read -r test_name; do
            if [ -n "$test_name" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ”„ Retrying: $test_name"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Try to run the specific test
              set +e
              dotnet test \
                --no-build \
                --filter "FullyQualifiedName~${test_name}" \
                --logger "console;verbosity=normal"
              TEST_RESULT=$?
              set -e
              
              if [ $TEST_RESULT -eq 0 ]; then
                echo "   âœ… PASSED on retry"
                ((RETRY_PASSED++))
              else
                echo "   âŒ FAILED again"
                ((RETRY_FAILED++))
              fi
            fi
          done <<< "$FAILED_TESTS"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Retry Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Tests failed initially: $FAILED_COUNT"
          echo "Passed on retry:        $RETRY_PASSED"
          echo "Still failed:           $RETRY_FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Save outputs for summary
          echo "total_failed=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "retry_passed=$RETRY_PASSED" >> $GITHUB_OUTPUT
          echo "retry_failed=$RETRY_FAILED" >> $GITHUB_OUTPUT
          
          # Exit with failure if any tests still failed
          if [ $RETRY_FAILED -gt 0 ]; then
            echo ""
            echo "âŒ $RETRY_FAILED test(s) still failing after retry"
            exit 1
          else
            echo ""
            echo "âœ… All failed tests passed on retry!"
            exit 0
          fi
        env:
          TestSettings__TEST_USERNAME: ${{ secrets.PLAYWRIGHT_USERNAME }}
          TestSettings__TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_PASSWORD }}
          TestSettings__TEST_TOTP_SECRET: ${{ secrets.PLAYWRIGHT_TOTP_SECRET }}
          TestSettings__TEST_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_BASE_URL: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_BASE_URL }}
          TestSettings__TEST_OPEN_KLANT_SECRET: ${{ secrets.PLAYWRIGHT_OPEN_KLANT_SECRET }}

      - name: Generate Summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          FIRST_EXIT="${{ steps.first-run.outputs.exit_code }}"
          
          if [ "$FIRST_EXIT" == "0" ]; then
            echo "âœ… **All tests passed on first run!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **First run had failures**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            TOTAL="${{ steps.retry-run.outputs.total_failed }}"
            PASSED="${{ steps.retry-run.outputs.retry_passed }}"
            FAILED="${{ steps.retry-run.outputs.retry_failed }}"
            
            if [ -n "$TOTAL" ] && [ "$TOTAL" != "0" ]; then
              echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Failed on first run | $TOTAL |" >> $GITHUB_STEP_SUMMARY
              echo "| Passed on retry | $PASSED |" >> $GITHUB_STEP_SUMMARY
              echo "| Still failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if [ "$FAILED" == "0" ]; then
                echo "âœ… **All failed tests passed on retry!**" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ **Some tests still failing after retry**" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [View Playwright Traces](https://klantinteractie-servicesysteem.github.io/KISS-frontend/)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./Kiss.Bff.EndToEndTest/bin/Debug/net8.0/playwright-traces"
      
      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: Kiss.Bff.EndToEndTest/bin/Debug/net8.0/screenshots/
          retention-days: 30

  deploy:
    if: ${{ always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request' }}
    needs: test
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
